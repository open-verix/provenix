name: Attest Provenix Binary

on:
  push:
    tags: ["v*"]
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write # OIDC token for keyless signing
  contents: write # Upload attestation to releases
  packages: write # Publish to GitHub Packages (future)

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for version info

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"
          cache: true

      - name: Run tests
        run: |
          go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          files: ./coverage.txt
          flags: unittests
          name: codecov-provenix

      - name: Build Provenix (Reproducible)
        run: |
          # Reproducible build with version info
          VERSION="${GITHUB_REF_NAME:-dev}"
          COMMIT="${GITHUB_SHA::8}"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          go build -trimpath -buildvcs=false \
            -ldflags="-s -w \
              -X main.version=${VERSION} \
              -X main.commit=${COMMIT} \
              -X main.buildTime=${BUILD_TIME}" \
            -o provenix ./cmd/provenix

      - name: Verify binary
        run: |
          ./provenix --version
          ./provenix --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: provenix-binary-${{ github.sha }}
          path: provenix
          retention-days: 30

  attest-self:
    name: Dog Fooding - Attest Provenix with Itself
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: provenix-binary-${{ github.sha }}

      - name: Make binary executable
        run: chmod +x provenix

      - name: Generate Attestation (Dog Fooding)
        id: attest
        run: |
          # Attest Provenix binary with itself
          ./provenix attest provenix \
            --format cyclonedx \
            --output attestation.json \
            --skip-transparency

          # Show attestation summary
          echo "Attestation generated:"
          jq '.artifact, .artifactDigest, .metadata.generatedAt' attestation.json || true

      - name: Validate attestation structure
        run: |
          # Verify attestation is valid JSON
          jq empty attestation.json

          # Check required fields
          jq -e '.artifact' attestation.json
          jq -e '.artifactDigest' attestation.json
          jq -e '.sbom' attestation.json
          jq -e '.vulnerabilityReport' attestation.json
          jq -e '.signature' attestation.json
          jq -e '.metadata' attestation.json

          echo "✓ Attestation structure validated"

      - name: Generate SBOM summary
        run: |
          echo "## SBOM Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL_PACKAGES=$(jq '.sbom.content | fromjson | .components | length' attestation.json 2>/dev/null || echo "N/A")
          echo "- **Total Packages:** ${TOTAL_PACKAGES}" >> $GITHUB_STEP_SUMMARY

          VULN_COUNT=$(jq '.vulnerabilityReport.vulnerabilities | length' attestation.json 2>/dev/null || echo "0")
          echo "- **Vulnerabilities Found:** ${VULN_COUNT}" >> $GITHUB_STEP_SUMMARY

          FORMAT=$(jq -r '.sbom.format' attestation.json 2>/dev/null || echo "N/A")
          echo "- **SBOM Format:** ${FORMAT}" >> $GITHUB_STEP_SUMMARY

          SIGNER=$(jq -r '.metadata.signerProvider.name' attestation.json 2>/dev/null || echo "N/A")
          echo "- **Signer:** ${SIGNER}" >> $GITHUB_STEP_SUMMARY

      - name: Upload attestation artifact
        uses: actions/upload-artifact@v4
        with:
          name: provenix-attestation-${{ github.sha }}
          path: attestation.json
          retention-days: 90

      - name: Attach to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            provenix
            attestation.json
          body: |
            ## Provenix ${{ github.ref_name }}

            This release includes:
            - Provenix binary (reproducible build)
            - Attestation (SBOM + Vulnerability Scan + Signature)

            ### Verification

            ```bash
            # Download artifacts
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/provenix
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/attestation.json

            # Verify attestation (future)
            ./provenix verify attestation.json
            ```

            ### Dog Fooding

            This attestation was generated by Provenix itself, demonstrating:
            - ✅ Atomic evidence generation
            - ✅ SBOM transparency
            - ✅ Vulnerability disclosure
            - ✅ Cryptographic signing

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
