name: Attest Provenix Binary

on:
  push:
    tags: ["v*"]
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write # OIDC token for keyless signing
  contents: write # Upload attestation to releases
  packages: write # Publish to GitHub Packages (future)
  security-events: write # Upload Trivy SARIF results to GitHub Security

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-24.04 # Pinned for reproducible builds

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for version info

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"
          cache: true

      - name: Run tests
        run: |
          go test ./... -v -race -coverprofile=coverage.txt -covermode=atomic

      - name: Upload coverage
        id: codecov
        uses: codecov/codecov-action@v4
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.txt
          flags: unittests
          name: codecov-provenix
          fail_ci_if_error: false

      - name: Warn if Codecov upload failed
        if: steps.codecov.outcome == 'failure'
        run: |
          echo "::warning::Codecov upload failed. This is optional for alpha releases."
          echo "::warning::To enable coverage reporting, add CODECOV_TOKEN secret."
          echo "::warning::See: https://docs.codecov.com/docs/codecov-tokens"

      - name: Build Provenix (Reproducible)
        run: |
          # Reproducible build with version info
          VERSION="${GITHUB_REF_NAME:-dev}"
          COMMIT="${GITHUB_SHA::8}"
          BUILD_TIME="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          go build -trimpath -buildvcs=false \
            -ldflags="-s -w \
              -X main.version=${VERSION} \
              -X main.commit=${COMMIT} \
              -X main.buildTime=${BUILD_TIME}" \
            -o provenix ./cmd/provenix

      - name: Verify binary
        run: |
          ./provenix --version
          ./provenix --help

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: provenix-binary-${{ github.sha }}
          path: provenix
          retention-days: 30

  attest-self:
    name: Dog Fooding - Attest Provenix with Itself
    runs-on: ubuntu-24.04 # Pinned for reproducible builds
    needs: build-and-test
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main')
    permissions:
      id-token: write # Required for OIDC token
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: provenix-binary-${{ github.sha }}

      - name: Make binary executable
        run: chmod +x provenix

      - name: Generate Attestation (Dog Fooding)
        id: attest
        run: |
          # Retry logic for transient OIDC failures (GitHub Actions 503 errors)
          MAX_RETRIES=3
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i/$MAX_RETRIES: Attesting Provenix binary..."
            
            if ./provenix attest provenix \
              --format cyclonedx-json \
              --output attestation.json \
              --skip-transparency; then
              echo "✓ Attestation successful"
              break
            else
              EXIT_CODE=$?
              if [ $i -lt $MAX_RETRIES ]; then
                echo "⚠️  Attempt $i failed (exit $EXIT_CODE), retrying in ${RETRY_DELAY}s..."
                sleep $RETRY_DELAY
              else
                echo "❌ All $MAX_RETRIES attempts failed"
                exit $EXIT_CODE
              fi
            fi
          done

          # Show attestation summary
          echo "Attestation generated:"
          STATEMENT=$(jq -r '.statementBase64' attestation.json | base64 -d)
          echo "$STATEMENT" | jq -r '.subject[0].name, .subject[0].digest.sha256, .predicate.metadata.generatedAt' || true

      - name: Validate attestation structure
        run: |
          # Verify attestation is valid JSON
          jq empty attestation.json

          # Check top-level fields (in-toto bundle format)
          jq -e '.signature' attestation.json
          jq -e '.statementBase64' attestation.json
          jq -e '.publicKey' attestation.json

          # Decode and check statement fields
          STATEMENT=$(jq -r '.statementBase64' attestation.json | base64 -d)
          echo "$STATEMENT" | jq -e '.subject'
          echo "$STATEMENT" | jq -e '.predicate.sbom'
          echo "$STATEMENT" | jq -e '.predicate.vulnerabilityReport'
          echo "$STATEMENT" | jq -e '.predicate.metadata'

          echo "✓ Attestation structure validated"

      - name: Generate SBOM summary
        run: |
          echo "## SBOM Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Decode statement
          STATEMENT=$(jq -r '.statementBase64' attestation.json | base64 -d)

          # Extract artifact info
          ARTIFACT=$(echo "$STATEMENT" | jq -r '.subject[0].name' 2>/dev/null || echo "N/A")
          echo "- **Artifact:** ${ARTIFACT}" >> $GITHUB_STEP_SUMMARY

          DIGEST=$(echo "$STATEMENT" | jq -r '.subject[0].digest.sha256' 2>/dev/null || echo "N/A")
          echo "- **SHA256:** ${DIGEST:0:16}..." >> $GITHUB_STEP_SUMMARY

          # Extract SBOM info
          TOTAL_PACKAGES=$(echo "$STATEMENT" | jq '.predicate.sbom.content | fromjson | .components | length' 2>/dev/null || echo "N/A")
          echo "- **Total Packages:** ${TOTAL_PACKAGES}" >> $GITHUB_STEP_SUMMARY

          VULN_COUNT=$(echo "$STATEMENT" | jq '.predicate.vulnerabilityReport.vulnerabilities | length' 2>/dev/null || echo "0")
          echo "- **Vulnerabilities Found:** ${VULN_COUNT}" >> $GITHUB_STEP_SUMMARY

          FORMAT=$(echo "$STATEMENT" | jq -r '.predicate.sbom.format' 2>/dev/null || echo "N/A")
          echo "- **SBOM Format:** ${FORMAT}" >> $GITHUB_STEP_SUMMARY

          SIGNER=$(echo "$STATEMENT" | jq -r '.predicate.metadata.signerProvider.name' 2>/dev/null || echo "N/A")
          echo "- **Signer:** ${SIGNER}" >> $GITHUB_STEP_SUMMARY

      - name: Upload attestation artifact
        uses: actions/upload-artifact@v4
        with:
          name: provenix-attestation-${{ github.sha }}
          path: attestation.json
          retention-days: 90

      - name: Attach to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            provenix
            attestation.json
          body: |
            ## Provenix ${{ github.ref_name }}

            This release includes:
            - Provenix binary (reproducible build)
            - Attestation (SBOM + Vulnerability Scan + Signature)

            ### Verification

            ```bash
            # Download artifacts
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/provenix
            wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/attestation.json

            # Verify attestation (future)
            ./provenix verify attestation.json
            ```

            ### Dog Fooding

            This attestation was generated by Provenix itself, demonstrating:
            - ✅ Atomic evidence generation
            - ✅ SBOM transparency
            - ✅ Vulnerability disclosure
            - ✅ Cryptographic signing

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-24.04 # Pinned for reproducible builds
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "."
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
