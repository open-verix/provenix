name: Test OIDC Keyless Signing (Week 11-16)

on:
  workflow_dispatch: # Manual trigger for testing
  push:
    branches: [main]
    paths:
      - ".github/workflows/test-oidc.yml"
      - "internal/providers/signer/cosign/**"

permissions:
  id-token: write # Required for OIDC token (GitHub Actions â†’ Fulcio)
  contents: read

jobs:
  test-keyless-signing:
    name: Keyless Signing End-to-End Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25.7"
          cache: true

      - name: Verify Go installation
        run: |
          go version
          go env GOVERSION

      - name: Download dependencies
        run: go mod download

      - name: Verify source files
        run: |
          echo "=== Checking cmd/provenix directory ==="
          ls -la cmd/provenix/
          echo ""
          echo "=== Content of main.go ==="
          cat cmd/provenix/main.go

      - name: Build Provenix
        run: go build -v -o provenix ./cmd/provenix

      - name: Display OIDC environment info
        run: |
          echo "=== GitHub Actions OIDC Environment ==="
          echo "GITHUB_ACTIONS: $GITHUB_ACTIONS"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:0:50}..."
          echo "GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "GITHUB_WORKFLOW: $GITHUB_WORKFLOW"
          echo "GITHUB_RUN_ID: $GITHUB_RUN_ID"
          echo "GITHUB_SHA: $GITHUB_SHA"
          echo "GITHUB_ACTOR: $GITHUB_ACTOR"
          echo "========================================"

      - name: Test 1 - OIDC Token Acquisition
        run: |
          echo "### Test 1: OIDC Token Acquisition" | tee -a $GITHUB_STEP_SUMMARY
          cat > test_oidc_token.go <<'EOF'
          package main
          import (
            "context"
            "fmt"
            "os"
            "github.com/open-verix/provenix/internal/providers/signer/cosign"
          )
          func main() {
            provider := cosign.NewOIDCTokenProvider("sigstore")
            token, err := provider.GetToken(context.Background())
            if err != nil {
              fmt.Fprintf(os.Stderr, "âŒ Failed to get OIDC token: %v\n", err)
              os.Exit(1)
            }
            fmt.Printf("âœ… OIDC token acquired (length: %d characters)\n", len(token))
            
            // Show detected environment
            envInfo := cosign.GetEnvironmentInfo()
            fmt.Println("\nðŸ“‹ Detected CI Environment:")
            for k, v := range envInfo {
              fmt.Printf("  - %s: %s\n", k, v)
            }
          }
          EOF
          go run test_oidc_token.go
          echo "" | tee -a $GITHUB_STEP_SUMMARY
          echo "âœ… OIDC token successfully acquired from GitHub Actions" | tee -a $GITHUB_STEP_SUMMARY
          echo "" | tee -a $GITHUB_STEP_SUMMARY

      - name: Test 2 - Keyless Signing (Skip Rekor for speed)
        run: |
          echo "### Test 2: Keyless Signing with Fulcio (No Rekor)" | tee -a $GITHUB_STEP_SUMMARY
          ./provenix attest alpine:latest \
            --output /tmp/keyless-no-rekor.json \
            --skip-transparency 2>&1 || {
            exitcode=$?
            echo "Exit code: $exitcode"
            if [ $exitcode -eq 0 ]; then
              echo "âœ… Keyless signing successful (Fulcio certificate issued)" | tee -a $GITHUB_STEP_SUMMARY
              jq -r '.signature.certificate' /tmp/keyless-no-rekor.json | head -n 5
              exit 0
            else
              echo "âŒ Keyless signing failed (exit $exitcode)" | tee -a $GITHUB_STEP_SUMMARY
              exit $exitcode
            fi
          }

      - name: Test 3 - Full Keyless Signing with Rekor
        run: |
          echo "### Test 3: Full Keyless Signing (Fulcio + Rekor)" | tee -a $GITHUB_STEP_SUMMARY
          ./provenix attest alpine:latest \
            --output /tmp/keyless-full.json 2>&1 || {
            exitcode=$?
            echo "Exit code: $exitcode"
            if [ $exitcode -eq 0 ]; then
              echo "âœ… Full keyless signing successful (Fulcio + Rekor)" | tee -a $GITHUB_STEP_SUMMARY
            elif [ $exitcode -eq 2 ]; then
              echo "âš ï¸  Partial success: Signed but Rekor unavailable (exit 2)" | tee -a $GITHUB_STEP_SUMMARY
            else
              echo "âŒ Keyless signing failed (exit $exitcode)" | tee -a $GITHUB_STEP_SUMMARY
              exit $exitcode
            fi
          }

      - name: Verify attestation structure
        if: always()
        run: |
          echo "### Attestation Verification" | tee -a $GITHUB_STEP_SUMMARY

          for file in /tmp/keyless-no-rekor.json /tmp/keyless-full.json; do
            if [ -f "$file" ]; then
              echo "#### $(basename $file)" | tee -a $GITHUB_STEP_SUMMARY
              jq '{
                artifact,
                artifactDigest,
                signature: {
                  signerProvider: .signature.signerProvider,
                  signedAt: .signature.signedAt,
                  keyless: .signature.keyless,
                  hasCertificate: (.signature.certificate != null),
                  hasSignature: (.signature.signature != null),
                  rekorEntry: (.signature.rekorEntry.uuid // "none")
                }
              }' "$file" | tee -a verification_result.json
              
              # Add to summary
              cat verification_result.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload attestation artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: keyless-attestations-${{ github.run_id }}
          path: /tmp/keyless-*.json
          retention-days: 30

      - name: Final summary
        if: always()
        run: |
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ‰ Test Completion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This workflow tests the complete Week 11-16 implementation:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… OIDC token acquisition (GitHub Actions â†’ Sigstore)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Keyless signing with Fulcio CA" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Rekor transparency log publishing" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Atomic evidence generation (SBOM + Scan + Signature)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** GitHub Actions with \`id-token: write\` permission" >> $GITHUB_STEP_SUMMARY
          echo "**Artifact:** \`keyless-attestations-${{ github.run_id }}\`" >> $GITHUB_STEP_SUMMARY
