name: Test OIDC Keyless Signing

on:
  workflow_dispatch: # Manual trigger for testing
  push:
    branches: [main]
    paths:
      - ".github/workflows/test-oidc.yml"
      - "internal/providers/signer/cosign/**"

permissions:
  id-token: write # Required for OIDC token
  contents: read

jobs:
  test-keyless-signing:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"

      - name: Build Provenix
        run: go build ./cmd/provenix

      - name: Display environment info
        run: |
          echo "=== GitHub Actions OIDC Environment ==="
          echo "GITHUB_ACTIONS=$GITHUB_ACTIONS"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=$ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "GITHUB_REPOSITORY=$GITHUB_REPOSITORY"
          echo "GITHUB_WORKFLOW=$GITHUB_WORKFLOW"
          echo "GITHUB_RUN_ID=$GITHUB_RUN_ID"
          echo "GITHUB_SHA=$GITHUB_SHA"
          echo "GITHUB_ACTOR=$GITHUB_ACTOR"
          echo "========================================"

      - name: Test OIDC token acquisition
        run: |
          cat > test_oidc.go <<'EOF'
          package main
          import (
            "context"
            "fmt"
            "os"
            "github.com/open-verix/provenix/internal/providers/signer/cosign"
          )
          func main() {
            provider := cosign.NewOIDCTokenProvider("sigstore")
            token, err := provider.GetToken(context.Background())
            if err != nil {
              fmt.Fprintf(os.Stderr, "Failed to get OIDC token: %v\n", err)
              os.Exit(1)
            }
            fmt.Printf("âœ… OIDC token acquired (length: %d)\n", len(token))
            
            // Show environment info
            envInfo := cosign.GetEnvironmentInfo()
            fmt.Println("\nðŸ“‹ Detected Environment:")
            for k, v := range envInfo {
              fmt.Printf("  %s: %s\n", k, v)
            }
          }
          EOF
          go run test_oidc.go

      - name: Test keyless signing (stub mode)
        run: |
          echo "Testing keyless signing with OIDC..."
          ./provenix attest alpine:latest --local --output /tmp/test-attestation-ci.json 2>&1 || {
            exitcode=$?
            echo "Exit code: $exitcode"
            if [ $exitcode -eq 2 ]; then
              echo "âœ… Partial success (Exit 2): Signature created, Rekor unavailable (expected in stub mode)"
              cat /tmp/test-attestation-ci.json | jq -r '.signature.signer_provider'
              exit 0
            else
              echo "âŒ Unexpected exit code: $exitcode"
              exit $exitcode
            fi
          }

      - name: Verify attestation structure
        if: always()
        run: |
          if [ -f /tmp/test-attestation-ci.json ]; then
            echo "=== Attestation File Contents ==="
            jq '{
              artifact,
              signature: {
                signer_provider: .signature.signer_provider,
                signed_at: .signature.signed_at,
                signature_length: (.signature.signature | length),
                has_certificate: (.signature.certificate != null),
                has_public_key: (.signature.public_key != null)
              }
            }' /tmp/test-attestation-ci.json
          else
            echo "âš ï¸  Attestation file not created"
          fi

      - name: Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Detection" >> $GITHUB_STEP_SUMMARY
          echo "- Provider: GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- Repository: $GITHUB_REPOSITORY" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow: $GITHUB_WORKFLOW" >> $GITHUB_STEP_SUMMARY
          echo "- Run ID: $GITHUB_RUN_ID" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OIDC Token" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully acquired from GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Keyless Signing" >> $GITHUB_STEP_SUMMARY
          echo "Status: Stub implementation (Fulcio/Rekor integration in Week 13-15)" >> $GITHUB_STEP_SUMMARY
